\chapter{Base change}
\label{ch:satake}

This section introduces necessary background material on the base change
\[ \BC_{S_n}^{\eta^{n-1}} \colon \HH(S_n(F)) \to \HH(\U(\VV_n^+)). \]

Throughout this section we let $\Sym(n)$ denote the symmetric group in $n$ variables
with order $n!$
(since $S_n(F) \subseteq \GL_n(E)$ is already reserved for the symmetric space).

\section{Background on the Satake transformation in transformation}
We recall a general form of the Satake transformation, which will be used later.

For this subsection, $G$ will denote an arbitrary connected reductive group
over some non-Archimedean local field $F$.
We will not distinguish between $G$ and $G(F)$ when there is no confusion.

To simplify things, we will assume $G$ is unramified;
but we do \emph{not} assume $G$ is split.
Introduce the following notation:
\begin{itemize}
  \ii Let $K$ be a hyperspecial maximal compact subgroup of $G$
  (it exists because $G$ is unramified).
  \ii Let $A$ denote a maximal $F$-split torus in $G$.
  All the maximal $F$-split tori in $G$ are conjugate; let $A$ denote one of them.
  \ii Let $M$ be the centralizer of $A$; this is itself a maximal torus in $G$.
  \ii Let $\prescript{\circ}{} M \coloneqq M(F) \cap K$
  be the maximal compact subgroup of $M$.
  \ii Let $P$ denote a minimal $F$-parabolic containing $A$.
  \ii Let $\delta$ denotes the modulus character of $P$.
  It can be describes as follows.
  Let $\varpi$ denote a uniformizer for $F$ and $q$ the residue characteristic.
  Then if $\rho$ is the Weyl vector and $\mu$ is a positive cocharacter, then
  \[ \delta(\mu(\varpi)) = q^{- \left< \mu, \rho\right>}. \]
  \ii Let $N$ denote the unipotent radical of $P$.
  \ii Let $W$ be the relative Weyl group for the pair $(G,A)$,
  which acts on $\HH(M, \prescript{\circ}{} M)$.
\end{itemize}
We can now state the Satake isomorphism.
\begin{definition}
  [Satake transform]
  The \emph{Satake transform} is a canonical isomorphism of Hecke algebras
  \[ \Sat \colon \HH(G, K) \to \HH(M, \prescript{\circ}{} M)^W \]
  which is given by defining
  \[ (\Sat(f))(t) \coloneqq \delta(t)^\half \int_N f(nt) \odif n  \]
  for each $t \in M$.
\end{definition}
We are going to apply this momentarily in two situations:
once when $G$ is the general linear group (which is split),
and once when $G$ is a unitary group.


\section{The Satake transformation for the particular Hecke algebras $\HH(\GL_n(E))$ and $\HH(\U(\VV_n^+))$}
To take the Satake transform of $\HH(\U(\VV_n^+))$, we define the following abbreviations.
\begin{itemize}
  \ii Let $T$ denote the split diagonal torus of $\GL_n$.
  \ii Let
  \[ N' \coloneqq \left\{ \begin{pmatrix}
      1 & \ast & \dots & \ast \\
        & 1 & \dots & \ast \\
        &   & \ddots & \vdots \\
        &   &   & 1 \end{pmatrix}\right\} \subseteq \GL_n(E) \]
  denote the unipotent upper-triangular matrices.
\end{itemize}
Similarly for $\HH(\U(\VV_n^+))$:
\begin{itemize}
  \ii Set $m \coloneqq \left\lfloor n/2 \right\rfloor$ for brevity.
  \ii Let
  \[ A \coloneqq \left\{
    \diag(x_1, \dots, x_m, 1_{n-2m}, x_m\inv, \dots, x_1\inv) \right\} \]
  so that $A(F)$ is a maximal $F$-split torus of $\U(\VV_n^+)$.
  \ii Let $N \coloneqq N' \cap G$ denote the unipotent upper triangular matrices
  which are also unitary.
  \ii For brevity, let $W_m \coloneqq (\ZZ/2\ZZ)^m \rtimes \Sym(m)$
  be the relative Weyl group of $(G,A)$.
\end{itemize}

We can now introduce the Satake transform for our two
\emph{bona fide} Hecke algebras, using the data in Table~\ref{tab:satakestuff}.

\begin{table}[ht]
  \centering
  \begin{tabular}{lll}
    \toprule
    Group & $G' = \GL_n(E)$ & $G = \U(\VV_n^+)$ \\ \midrule
    Local field & $E$ & $F$ \\\hline
    Hyperspecial compact & $K' = \GL_n(\OO_E)$ & $K = G \cap \GL_n(\OO_E)$ \\\hline
    Max'l split torus & $T(E)$ & $A(F)$ \\\hline
    Centralizer of split torus & $T(\OO_E)$ & $A(\OO_F)$ \\\hline
    Parabolic (Borel) & Upper tri in $G'$ & Upper tri in $G$ \\\hline
    Unipotent rad.\ of parabolic & $N'$ (unipot.\ upper tri) & $N$ (unipot.\ upper tri) \\\hline
    Relative Weyl group & $\Sym(n)$ & $W_m = (\ZZ/2\ZZ)^m \rtimes \Sym(m)$ \\
    %Cocharacter group & $\ZZ^{\oplus n}$ & $\ZZ^{\oplus m}$?? \\
    %Weyl vector & $\left< \frac{n-1}{2}, \frac{n-3}{2}, \dots, -\frac{n-1}{2} \right>$
    %            & $\left< \frac{m-1}{2}, \frac{m-3}{2}, \dots, -\frac{m-1}{2} \right>$??
    \bottomrule
  \end{tabular}
  \caption{Data needed to run the Satake transformation.}
  \label{tab:satakestuff}
\end{table}

Hence, the Satake transformations obtained can be viewed as
\begin{align*}
  \Sat &\colon \HH(\GL_n(E)) \xrightarrow{\sim} \QQ[T(E) / T(\OO_E)]^{\Sym(n)} \\
  \Sat &\colon \HH(\U(\VV_n^+))\xrightarrow{\sim} \QQ[A(F) / A(\OO_F)]^{W_m}
\end{align*}
(In both cases, the modular character $\delta^{1/2}$ gives rational values,
so it is okay to work over $\QQ$.)

To make this further concrete, we remark that the cocharacter groups
involved are free abelian groups with known bases.
This identification lets us rewrite the right-hand sides above as concrete polynomials.
Specifically, we identify
\[ \QQ[T(E) / T(\OO_E)]^{\Sym(n)}
  \xrightarrow{\sim} \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \]
by identifying $X_i$ with the
cocharacter corresponding to injection into the $i$\ts{th} factor.
Similarly, we identify
\[ \QQ[A(F) / A(\OO_F)]^{W_m}
  \xrightarrow{\sim} \QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m} \]
by identifying $Y_i + Y_i^{-1}$
with the cocharacter corresponding to
\[ x \mapsto \diag(1, \dots, x, \dots, x\inv, \dots, 1) \]
where $x$ is in the $i$\ts{th} position and $x\inv$ is in the $(n-i)$\ts{th} position,
and all other positions are $1$.
Here $\QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m}$
denotes the ring of symmetric polynomials in $Y_i + Y_i^{-1}$.

So, henceforth, we will consider
\begin{align*}
  \Sat &\colon \HH(\GL_n(E)) \xrightarrow{\sim} \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \\
  \Sat &\colon \HH(\U(\VV_n^+)) \xrightarrow{\sim} \QQ[Y_1^{\pm}, \dots, Y_m^{\pm}]^{W_m}.
\end{align*}

\section{Relation of Satake transformation to base change}
Let
\[ \BC \colon \HH(\GL_n(E)) \to \HH(\U(\VV_n^+)) \]
denote the stable base change morphism from $\GL_n(E)$ to the unitary group $\U$.
The relevance of the Satake transformation is that
(see e.g.\ \cite[Proposition 3.4]{ref:leslie})
it gives a way to make this $\BC$ completely explicit:
we have a commutative diagram
\begin{center}
\begin{tikzcd}
  \HH(\GL_n(E))  \ar[r, "\sim"', "\Sat"] \ar[d, "\BC"]
    & \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \ar[d, "\BC"] \\
  \HH(\U(\VV_n^+)) \ar[r, "\sim"', "\Sat"]
    & \QQ[Y_1^\pm, \dots, Y_m^\pm]^{W_m}
\end{tikzcd}
\end{center}
Here the right arrow is also denoted $\BC$ following \cite{ref:AFLspherical}
(although it is denoted $\nu$ in \cite{ref:leslie}).
This gives a way in which we can concretely calculate the map $\BC$
in some situations.

\section{The map $\BC^{\eta^{n-1}}_{S_n}$}
Before we can define the map $\BC^{\eta^{n-1}}_{S_n}$
we need one more piece of notation.
Consider the following map.
\begin{definition}
  [$\rproj$]
  Denote by $\rproj \colon \GL_n(E) \surjto S_n(F)$ the projection defined by
  \[ \rproj(g) \coloneqq g \bar{g}\inv. \]
\end{definition}
Then $\rproj$ induces a map
\begin{align*}
  \rproj_\ast \colon \HH(\GL_n(E)) &\to \HH(S_n(F)) \\
  \rproj_\ast(f')\left( g\bar{g}\inv \right) &= \int_{\GL_n(F)} f'(gh) \odif h
\end{align*}
by integration on the fibers.
A similar twisted version by $\eta$
\begin{align*}
  \rproj_\ast^\eta \colon \HH(\GL_n(E)) &\to \HH(S_n(F)) \\
  \rproj_\ast^\eta(f')\left( g\bar{g}\inv \right) &= \int_{\GL_n(F)} f'(gh) \eta(gh) \odif h
\end{align*}
is defined analogously,
where as before $\eta(g) = (-1)^{v(\det g)}$ in a slight abuse of notation.

Then Leslie \cite{ref:leslie} shows the following result.
\begin{theorem}
  [{\cite[Theorem 3.2 and Proposition 3.4]{ref:leslie}}]
  Both maps $\rproj_\ast$ and $\rproj_\ast^\eta$ induce isomorphisms
  \begin{align*}
    \BC_{S_n} \colon \HH(S_n(F)) &\xrightarrow{\sim} \HH(\GL_n(E)) \\
    \BC^{\eta^{n-1}}_{S_n} \colon \HH(S_n(F)) &\xrightarrow{\sim} \HH(\GL_n(E))
  \end{align*}
  such that
  \begin{align*}
    \BC &= \BC_{S_n} \circ \rproj_\ast \\
    \BC &= \BC^{\eta^{n-1}}_{S_n} \circ \rproj_\ast^{\eta^{n-1}}.
  \end{align*}
\end{theorem}
We take these isomorphisms promised by this theorem
as the definition of $\BC_{S_n}$ and $\BC^{\eta^{n-1}}_{S_n}$ in our conjectures
(noting when $n$ is odd they coincide, as $\eta^{n-1} = 1$).

When combined with the Satake information we have, we get the following diagram.
\begin{center}
\begin{tikzcd}
  \HH(\GL_n(E)) \ar[dd, "\rproj_\ast^{\eta^{n-1}}"', bend right = 60] \ar[r, "\sim"', "\Sat"] \ar[d, "\BC"]
    & \QQ[X_1^\pm, \dots, X_n^\pm]^{\Sym(n)} \ar[d, "\BC"] \\
  \HH(\U(\VV_n^+)) \ar[r, "\sim"', "\Sat"]
    & \QQ[Y_1^\pm, \dots, Y_m^\pm]^{W_m} \\
    \HH(S_n(F)) \ar[u, "\sim", "\BC_{S_n}^{\eta^{n-1}}"']
\end{tikzcd}
\end{center}

\section{Calculation of $\BC_{S_n}$ when $n = 3$}
The goal of this section is to make the base change
fully known in the special case $n = 3$, where $m = \left\lfloor n/2 \right\rfloor = 1$.
(In this case $\BC_{S_n}^{\eta^{n-1}} = \BC_{S_n}$ as $\eta^2 = 1$.)
The completed result is \Cref{prop:BC_S3}.

This calculation parallels the $n = 2$ case that was done in \cite[Lemma 7.1.1]{ref:AFLspherical}.
However, we will not use these results again later on.
When it is not more difficult, some of the results will be stated for all $n$,
rather than $n = 3$ specifically.

\subsection{Overview}
Throughout this subsection, we use the shorthand
\[ \varpi^{(n_1, n_2, n_3)} \coloneqq \diag(\varpi^{n_1}, \varpi^{n_2}, \varpi^{n_3}). \]
As a $\QQ$-module, the spaces $\HH(\U(\VV_n^+))$ and $\HH(S_n(F))$
have a canonical basis of indicator functions indexed by $\ZZ$:
\begin{itemize}
  \ii $\HH(S_n(F))$ has $\QQ$-module basis $\mathbf{1}_{K'_{S,j}}$ for $j \ge 0$.
  \ii $\HH(\U(\VV_n^+))$ has a $\QQ$-module basis given by the indicator functions
  \[ \mathbf{1}_{\varpi^{-r} \Mat(\OO_E) \cap \U(\VV_n^+)} \]
  for $r \ge 0$.
\end{itemize}
On the other hand, the natural $\QQ$-module basis for $\HH(\GL_n(E))$, namely
\[ \mathbf{1}_{K'\varpi^{(n_1, n_2, n_3)}K'} \]
is given by triples of integers $n_1 \ge n_2 \ge n_3 \ge 0$, and is much larger.
So explicit calculations for the $\rproj_\ast$ or the Satake transforms viewed in
$\CC[X_1, X_2, X_3]^{\Sym(n)}$ are nontrivial if one works with the entire basis.

Hence the overall strategy, to reduce the amount of work we have to do,
is to focus on only the $\ZZ$-indexed elements
\[
  \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}
  = \sum_{\substack{n_1 \ge n_2 \ge n_3 \\ n_1 + n_2 + n_3 = r}}
  \mathbf{1}_{K'\varpi^{(n_1, n_2, n_3)}K'} \in \HH(\GL_n(E))
\]
for $r \ge 0$.
This aggregated indicator function is easier to compute,
because given an explicit matrix it is somewhat easier
to evaluate \[ \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r} \]
at it (one only needs to check it has $\OO_E$ entries
and that the determinant has valuation $r$,
rather than determining the exact coset $K'\varpi^{(n_1, n_2, n_3)}K'$).

\subsection{Satake transform of the determinant characteristic function on the top arrow}
This is the easiest calculation, and we do it for all $n$ rather than just $n = 3$.
\begin{proposition}
  [Satake transform for $v \circ \det = r$]
  For every integer $r \ge 0$, we have
  \[ \Sat(\mathbf{1}_{\Mat_n(\OO_E), v\circ\det=r})
    = q^{(n-1)r} \sum_{e_1 \dots + e_n = r} X_1^{e_1} \dots X_n^{e_n}. \]
\end{proposition}
\begin{proof}
  We evaluate the coefficient $X_1^{e_1} \dots X_n^{e_n}$.
  Choose a cocharacter $\mu$,
  and suppose $\mu(\varpi) = \varpi^{(e_1, \dots, e_n)}$ with $n_1 \ge n_2 \ge n_3$.
  Let $q_E = q^2$ be the residue characteristic of $E$.
  Take the upper triangular matrices as our Borel subgroup as usual,
  so the unipotent radical of this Borel subgroup
  are the unipotent upper triangulars $N'$ which we describe as
  \[ N' \coloneqq \left\{
      \begin{pmatrix}
      1 & y_{12} & y_{13} & \dots & y_{1n} \\
        & 1 & y_{23} & \dots & y_{2n} \\
        &   & 1 & \dots & y_{3n} \\
        &   &   & \ddots & \vdots  \\
        &   &   &   & 1
      \end{pmatrix}
    \mid y_{12}, \dots, y_{(n-1)n}\in E \right\} \]
  and with additive Haar measure is $\odif{y_{12}, y_{23} \dotso, y_{(n-1)n}}$.
  Recall also the Weyl vector for $\GL_n(E)$ is just
  \[ \rho_{\GL_n(E)} = \left< \frac{n-1}{2}, \frac{n-3}{2}, \dots, -\frac{n-1}{2} \right>. \]
  Compute
  \begin{align*}
    &\Sat(\mathbf{1}_{\Mat_n(\OO_E), v\circ\det=r})(\mu(\varpi)) \\
    &= \delta(\mu(\varpi))^\half \int_{n' \in N'}
      \mathbf{1}_{\Mat_n(\OO_E, v\circ \det = r)} (\mu(\varpi) n') \odif{n'} \\
    &= q_E^{-\left< \mu, \rho\right>}
    \underbrace{\int_{y_{12} \in E} \int_{y_{13} \in E} \dotso \int_{y_{(n-1)n} \in E}}_{\binom n2 \text{ integrals}} \\
    &\qquad
      \mathbf{1}_{\Mat_3(\OO_E), v \circ \det = r}
      \left( \begin{pmatrix}
        \varpi^{e_1} & \varpi^{e_1} y_{12} & \varpi^{e_1} y_{13} & \dots & \varpi^{e_1} y_{1n} \\
        & \varpi^{e_2} & \varpi^{e_2} y_{23} & \dots & \varpi^{e_2} y_{2n} \\
        &   & \varpi^{e_3} & \dots & \varpi^{e_3} y_{3n} \\
        &   &   & \ddots & \vdots  \\
        &   &   &   & \varpi^{e_n}
        \end{pmatrix} \right) \\
    &\qquad \odif{y_{12}, y_{23} \dotso, y_{(n-1)n}} \\
    &= q_E^{-\left(\frac{n-1}{2}e_1 + \frac{n-3}{2}e_2 + \dots + -\frac{n-1}{2} e_n \right)}
    \mathbf{1}_{e_1 + \dots + e_n = r}
    \underbrace{\int_{y_{12} \in E} \int_{y_{13} \in E} \dotso \int_{y_{(n-1)n} \in E}}_{\binom n2 \text{ integrals}} \\
    &\qquad \prod_{1 \le i < j \le n} \mathbf{1}_{\OO_E}(\varpi^{e_i} y_{ij}) \odif{y_{ij}} \\
    &= q_E^{-\left(\frac{n-1}{2}e_1 + \frac{n-3}{2}e_2 + \dots + -\frac{n-1}{2} e_n \right)}
    \mathbf{1}_{e_1 + \dots + e_n = r} \prod_{1 \le i < j \le n} q_E^{e_i} \\
    &= q_E^{-\left(\frac{n-1}{2}e_1 + \frac{n-3}{2}e_2 + \dots + -\frac{n-1}{2} e_n \right)}
    \mathbf{1}_{e_1 + \dots + e_n = r} \prod_{1 \le i \le n} q_E^{(n-i)e_i} \\
    &= \mathbf{1}_{e_1 + \dots + e_n = r} \prod_{1 \le i \le n}^n q_E^{\frac{n-1}{2} e_i} \\
    &= q_E^{\frac{n-1}{2} r} \mathbf{1}_{e_1 + \dots + e_n = r} \\
    &= \begin{cases}
      q^{\frac{n-1}{2} r} & \text{if } e_1 + \dots + e_n = r \\
      0 & \text{otherwise}.
    \end{cases}
  \end{align*}
  This gives the sum claimed earlier.
\end{proof}


\subsection{Satake transform of the indicator on the bottom arrow}
\begin{proposition}
  [Satake transform for $\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)$]
  For each $r \ge 0$ we have
  \[ \Sat\left(\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}\right)
    = \sum_{i=0}^r q^{2r - \mathbf{1}_{r \equiv i \bmod 2}} Y_1^{\pm i} \]
  where we adopt the shorthand
  \[
    Y_1^{\pm i} \coloneqq
    \begin{cases}
      Y_1^i + Y_1^{-i} & i > 0 \\
      1 & i = 0 .
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  We first need to describe \[ N = N' \cap \U(\VV_3^+) \] a little more carefully.
  For $n \in N'$ we have
  \[
    n^\ast \beta n
    =
    \begin{pmatrix} 1 \\ \bar{y_1} & 1 \\ \bar{y_2} & \bar{y_3} & 1 \end{pmatrix}
    \beta
    \begin{pmatrix}
      1 & y_1 & y_2 \\
        & 1 & y_3 \\
        & & 1
    \end{pmatrix}
    = \begin{pmatrix}
      & & 1 \\
      & 1 & y_3 + \bar{y_1} \\
      1 & y_1 + \bar{y_3} & y_2 + \bar{y_2} + y_3 \bar{y_3}
    \end{pmatrix}.
  \]
  So $n \in N$ if and only if the above matrix equals $\beta$, which means
  \[ 0 = y_3 + \bar{y_1} = y_2 + \bar{y_2} + y_3 \bar{y_3}. \]
  Then we can re-parametrize by $z_1, z_2, z_3 \in F$ according to
  \begin{align*}
    y_3 &= z_1 + z_2 \sqrt\eps \\
    y_2 &= -\frac{z_1^2 + z_2^2 \eps}{2} + z_3\sqrt\eps \\
    y_1 &= -z_1 + z_2\sqrt\eps.
  \end{align*}
  Back to the original task.
  For each $i \ge 0$ we can evaluate the Satake transform at the element
  $\nu(\varpi) = \diag(\varpi^i, 1, \varpi^{-i})$, for the cocharacter $\nu$
  corresponding to $Y_1^i + Y_1^{-i}$:
  \begin{align*}
    &\Sat\left( \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}\right)
      \left( \nu(\varpi)  \right) \\
    &= \delta(\nu(\varpi))^\half \int_{n \in N}
      \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
      \left( \nu(\varpi) n' \right) \odif n \\
    &= \delta(\nu(\varpi))^\half \int_{n \in N}
      \mathbf{1}_{{\varpi^{-r}} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
      \left( \begin{pmatrix} \varpi^i & \varpi^i y_1 & \varpi^i y_2 \\
               & 1 & y_3 \\
               & & \varpi^{-i} \end{pmatrix} \right) \odif n
  \end{align*}
  The matrix itself is always in $\U(\VV_3^+)$, because it's the product of two unitary matrices.
  So the indicator needs to check whether all the entries have valuation at least $-r$.
  If we switch characterization to the coordinates $z_1$, $z_2$, $z_3$ we described earlier,
  we see that the conditions are
  \begin{align*}
    i &\le r, \\
    v(z_1) &\ge -r, \\
    v(z_2) &\ge -r,\\
    v(z_3) &\ge -(r+i),\\
    v(z_1^2 + z_2^2 \eps) &\ge -(r+i).
  \end{align*}
  Assume $i \le r$ henceforth.
  The condition for $z_1$ and $z_2$ then really says
  \[ \min(v(z_1), v(z_2)) \ge -\left\lfloor \frac{r+i}{2} \right\rfloor. \]
  So the integral factors as a triple integral
  \[
    \int_{z_1 \in F}
    \int_{z_2 \in F}
    \int_{z_3 \in F}
    \mathbf{1}_{\varpi^{-\left\lfloor \frac{r+i}{2} \right\rfloor} \OO_F}(z_1)
    \mathbf{1}_{\varpi^{-\left\lfloor \frac{r+i}{2} \right\rfloor} \OO_F}(z_2)
    \mathbf{1}_{\varpi^{-(r+i)} \OO_F}(z_3)
    \odif{z_1,z_2,z_3}
  \]
  which is equal to
  \[ q^{2\left\lfloor \frac{r+i}{2} \right\rfloor+r+i}. \]
  Meanwhile, $\delta(\nu(\varpi))^{\half} = q^{-2i}$.
  In summary,
  \[
    \Sat\left( \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}\right) \left( \nu(\varpi) \right)
    =
    \begin{cases}
      q^{2\left\lfloor \frac{r+i}{2} \right\rfloor - i + r} & i \le r \\
      0 & i > r
    \end{cases}
  \]
  Finally, since
  \[ 2\left\lfloor \frac{r+i}{2} \right\rfloor - i + r
    = \begin{cases}
      2r & r+i \text{ is even} \\
      2r-1 & r+i \text{ is odd}
    \end{cases}
  \]
  we get the formula claimed.
\end{proof}

\subsection{Integration over fiber}
\begin{proposition}
  [Integration over fiber]
  For every integer $r \ge 0$, we have
  \begin{align*}
    &\rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}) \\
    &= \sum_{j=0}^r \left(
      \sum_{i=0}^{2(r-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
        1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor \right) q^i \right)
        \mathbf{1}_{K'_{S,j}}.
  \end{align*}
\end{proposition}
\begin{proof}
  The coefficient of $\mathbf{1}_{K'_{S,j}}$ will be equal to
  the evaluation of the integral at any $g$ such that $g\bar{g} \in K'_{S,j}$.
  Fixing $j \ge 0$, we are going to take the choice
  \[
    g = \begin{pmatrix}
      1 &   & \varpi^{-j} \sqrt{\eps} \\
      & 1 \\
      &   & 1
    \end{pmatrix}.
  \]
  We need to check this choice of $g$ indeed satisfies $g\bar{g}\inv \in K'_{S,j}$.
  This follows as
  \[ \bar{g} = \begin{pmatrix} 1 &   & -\varpi^{-j} \sqrt{\eps} \\ & 1 \\ &   & 1 \end{pmatrix}
    \implies \bar{g}\inv = \begin{pmatrix} 1 &   & \varpi^{-j} \sqrt{\eps} \\ & 1 \\ &   & 1 \end{pmatrix}
  \]
  and therefore
  \[
    g\bar{g}\inv = \begin{pmatrix}
      1 &   & 2\varpi^{-j} \sqrt{\eps} \\
      & 1 \\
      &   & 1
    \end{pmatrix} \in K'_{S,j}
  \]
  as needed.

  Having chosen the representative $g$, we aim to calculate the right-hand side of
  \[
    \rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})(g\bar{g})
    = \int_{h \in \GL_3(F)} \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}(gh) \odif h.
  \]
  We take (non-Archimedean) Iwasawa decomposition of $h \in \GL_3(F)$ to rewrite it as
  \[
    h =
    \begin{pmatrix} x_1 \\ & x_2 \\ && x_3 \end{pmatrix}
    \begin{pmatrix} 1 & y_1 & y_2 \\ & 1 & y_3 \\ & & 1 \end{pmatrix}
    k
  \]
  for $k \in \GL_3(\OO_F) \subseteq K'$, which does not affect the indicator function.
  Here $x_1, x_2, x_3 \in F^\times$ and $y_1, y_2, y_3 \in F$.
  In that case, note that
  \begin{align*}
    gh
    &=
    \begin{pmatrix}
      1 &   & \varpi^{-j}\sqrt\eps \\
      & 1 \\
      &   & 1
    \end{pmatrix}
    \begin{pmatrix} x_1 \\ & x_2 \\ && x_3 \end{pmatrix}
    \begin{pmatrix} 1 & y_1 & y_2 \\ & 1 & y_3 \\ & & 1 \end{pmatrix} k \\
    &=
    \begin{pmatrix}
      1 &   & \varpi^{-j}\sqrt\eps \\
      & 1 \\
      &   & 1
    \end{pmatrix}
    \begin{pmatrix} x_1 & x_1 y_1 & x_1 y_2 \\ & x_2 & x_2 y_3 \\ & & x_3 \end{pmatrix} k \\
    &=
    \begin{pmatrix}
      x_1 & x_1 y_1 & x_1 y_2 + x_3 \varpi^{-j} \sqrt\eps \\
      & x_2 & x_2 y_3 \\
      & & x_3
    \end{pmatrix}
    k.
  \end{align*}
  Hence, we can rewrite the $\rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r})$
  as a six-fold integral
  \begin{align*}
    &\rproj_\ast(\mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r}) \\
    &= \int_{x_1 \in F^\times} \int_{x_2 \in F^\times} \int_{x_3 \in F^\times}
    \int_{y_1 \in F} \int_{y_2 \in F} \int_{y_3 \in F} \\
    &\quad \mathbf{1}_{\Mat_3(\OO_E), v\circ\det=r} \left(
    \begin{pmatrix}
      x_1 & x_1 y_1 & x_1 y_2 + x_3 \varpi^{-j} \sqrt\eps \\
      & x_2 & x_2 y_3 \\
      & & x_3
    \end{pmatrix}
    \right) \\
    &\quad \odif[{\times,\times,\times}]{x_1,x_2,x_3,y_1,y_2,y_3}.
  \end{align*}
  Apparently the indicator function only depends on the valuations,
  so accordingly we rewrite the six-fold integral as a discrete sum over the valuations
  $\alpha_i \coloneqq v(x_i)$.
  Then the conditions are that
  \begin{align*}
    &\alpha_1 \ge 0, \quad \alpha_2 \ge 0, \quad \alpha_3 \ge j \\
    &v(y_1) \ge - \alpha_1, \quad v(y_2) \ge - \alpha_1, \quad v(y_3) \ge -\alpha_2.
  \end{align*}
  We have $\Vol(\varpi^{\alpha_i} \OO_F^\times) = 1$
  and $\Vol(\varpi^{-\alpha_i} \OO_F) = q^{\alpha_i}$.
  Hence the integral can be rewritten as the discrete sum
  \begin{align*}
    \sum_{\substack{\alpha_1 + \alpha_2 + \alpha_3 = r \\ \alpha_1 \ge 0 \\ \alpha_2 \ge 0 \\ \alpha_3 \ge j}}
    q^{\alpha_1} \cdot q^{\alpha_1} \cdot q^{\alpha_2}
    &= \sum_{\substack{\alpha_1 + \alpha_2 \le r-j \\ \alpha_1 \ge 0 \\ \alpha_2 \ge 0}}
    q^{2\alpha_1+\alpha_2} \\
    &= \sum_{i=0}^{2(r-j)}
    \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
      1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor
    \right) q^i
  \end{align*}
  as desired.
\end{proof}

\subsection{Base change from $\HH(\U(\VV_3^+))$ to $\HH(S_3(F))$}
We first need to determine an element of $\HH(\U(\VV_n^+))$
which is in the pre-image of
\[ \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)} \]
under $\BC \colon \HH(\GL_3(E)) \to \HH(\U(\VV_3^+))$.

For convenience, we define the shorthand
\[
  \HH(\GL_3(E)) \ni
  f'_r \coloneqq \begin{cases}
    \mathbf{1}_{\Mat_3(\OO_E), v \circ \det = r} & r \ge 0 \\
    0 & r < 0
  \end{cases}
\]
for every integer $r$.
We start with the following intermediate calculation.
\begin{align*}
  &\BC\left( \Sat \left( f'_r - q^2 f'_{r-1} \right) \right) \\
  &= \BC \left(
    q^{2r} \sum_{n_1+n_2+n_3=r} X_1^{n_1} X_2^{n_2} X_3^{n_3}
    - q^2 \cdot q^{2(r-1)} \sum_{n_1+n_2+n_3=(r-1)} X_1^{n_1} X_2^{n_2} X_3^{n_3} \right) \\
  &= q^{2r} \left( \sum_{n_1+n_2+n_3=r} Y_1^{n_1-n_3} - \sum_{n_1+n_2+n_3=(r-1)} Y_1^{n_1-n_3} \right) \\
  &= q^{2r} \left( \sum_{n_1+n_3=r} Y_1^{n_1-n_3} \right) \\
  &= q^{2r} \left( Y_1^{r} + Y_1^{r-2} + \dots + Y_1^{-r} \right).
  \intertext{Replacing $r$ with $r-1$ gives}
  &\BC\left( \Sat \left(f'_{r-1} - q^2 f'_{r-2} \right) \right) \\
  &= q^{2r-2} \left( Y_1^{r-1} + Y_1^{r-3} + \dots + Y_1^{-(r-1)} \right).
  \intertext{Adding the former equation to $q$ times the latter gives}
  &\BC\left( \Sat\left( f'_r + (q-q^2) f'_{r-1} - q^3 f'_{r-2} \right) \right) \\
  &= q^{2r} \left( Y_1^r + Y_1^{r-2} + \dots + Y_1^{-r} \right)
  + q^{2r-1} \left( Y_1^{r-1} + Y_1^{r-3} + \dots + Y_1^{-(r-1)} \right) \\
  &= \Sat(\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}).
\end{align*}
This shows that
\[ \BC(f'_r + (q-q^2) f'_{r-1} - q^3 f'_{r-2}) =
  \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)} \]
so indeed $f'_r + (q-q^2) f'_{r-1} - q^3 f'_{r-2}$
lies in the desired pre-image of the map $\BC \colon \HH(\GL_3(E)) \to \HH(\U(\VV_3^+))$.

On the other hand, it is easy to check that
\begin{align*}
  &\rproj_\ast(f'_r -q^2 f'_{r-1}) \\
  &= \sum_{j=0}^r \Bigg[
      \sum_{i=0}^{2(r-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
      1 + \left\lfloor \frac{2(r-j)-i}{2} \right\rfloor \right) q^i \\
  &\qquad - \sum_{i=0}^{2(r-1-j)} \min \left( 1 + \left\lfloor \frac i2 \right\rfloor,
    1 + \left\lfloor \frac{2((r-1)-j)-i}{2} \right\rfloor \right) q^{i+2}
  \Bigg] \mathbf{1}_{K'_{S,j}} \\
  &= \sum_{j=0}^r \left[ 1+q+q^2+\dots+q^{r-j} \right] \mathbf{1}_{K'_{S,j}} \\
  \intertext{so}
  &\rproj_\ast(f'_r -q^2 f'_{r-1} + q \left( f'_{r-1} - q^2 f'_{r-3} \right)) \\
  &= \sum_{j=0}^r \left[ (1+q+q^2+\dots+q^{r-j})+(q+q^2+\dots+q^{r-j}) \right] \mathbf{1}_{K'_{S,j}} \\
  &= \sum_{j=0}^r \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right] \mathbf{1}_{K'_{S,j}}.
\end{align*}
To summarize, the completed commutative diagram can be written in full as
\begin{center}
\begin{tikzcd}
  \begin{tabular}{c} $f'_r + (q-q^2) f'_{r-1}$ \\ $- q^3 f'_{r-2} \in \HH(\GL_3(E))$ \end{tabular}
    \ar[dd, "\rproj_\ast"', mapsto, bend right = 50]
    \ar[r, "\Sat", mapsto] \ar[d, "\BC", mapsto]
    & \dots \in \QQ[X_1^\pm, X_2^\pm, X_3^\pm]^{\Sym(3)} \ar[d, "\BC", mapsto] \\
  \begin{tabular}{c} $\mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}$ \\ $\in \HH(\U(\VV_3^+))$ \end{tabular}
    \ar[r, "\Sat", mapsto]
    & \begin{tabular}{l}
      $q^{2r} \left( Y_1^{\pm r} + \dotsb + Y_1^{\mp r} \right)$ \\
      $+ q^{2r-1} \left( Y_1^{\pm(r-1)} + \dotsb + Y_1^{\mp(r-1)} \right)$ \\
      $\in \QQ[Y_1^\pm]^{W_1}$
      \end{tabular} \\
  \begin{tabular}{c}
    $\sum_{j=0}^r \big[ 1 + 2q + 2q^2$ \\
    $+ \dots + 2q^{r-j} \big] \mathbf{1}_{K'_{S,j}}$ \\
    $\in \HH(S_3(F))$
  \end{tabular} \ar[u, "\sim", "\BC_{S_3}"', mapsto]
\end{tikzcd}
\end{center}

Thus, we arrive at the following:
\begin{proposition}
  [Base change $\BC_{S_3}$]
  \label{prop:BC_S3}
  For $n = 3$, we have
  \begin{align*}
    \BC_{S_3} \left( \sum_{j=0}^r \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right]
    \mathbf{1}_{K'_{S,j}} \right)
    &= \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)} \\
    \BC_{S_3} \left( \mathbf{1}_{K'_{S,r}}
    + \sum_{j=0}^{r-1} 2q^{r-j} \mathbf{1}_{K'_{S,j}} \right)
    &= \mathbf{1}_{K\varpi^{(r,0,-r)}K}
  \end{align*}
  for every integer $r \ge 0$.
\end{proposition}
\begin{proof}
  The first equation is the one we just proved.
  The second one follows by noting that
  \[
    \mathbf{1}_{K\varpi^{(r,0,-r)}K}
    = \mathbf{1}_{\varpi^{-r} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
    - \mathbf{1}_{\varpi^{-(r-1)} \Mat_3(\OO_E) \cap \U(\VV_3^+)}
  \]
  so one merely subtracts the left-hand sides evaluated at $r$ and $r-1$ for $r \ge 1$
  to get
  \begin{align*}
    &\phantom= \sum_{j=0}^r \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right] \mathbf{1}_{K'_{S,j}}
    - \sum_{j=0}^{r-1} \left[ 1 + 2q + 2q^2 + \dots + 2q^{(r-1)-j} \right] \mathbf{1}_{K'_{S,j}} \\
    &= \mathbf{1}_{K'_{S,r}} +
      \sum_{j=0}^{r-1} \left[ 1 + 2q + 2q^2 + \dots + 2q^{r-j} \right] \mathbf{1}_{K'_{S,j}}
    - \sum_{j=0}^{r-1} \left[ 1 + 2q + 2q^2 + \dots + 2q^{(r-1)-j} \right] \mathbf{1}_{K'_{S,j}} \\
    &= \mathbf{1}_{K'_{S,r}} + \sum_{j=0}^{r-1} \left[ 2q^{r-j}\mathbf{1}_{K'_{S,j}} \right].
  \end{align*}
  as claimed.
\end{proof}
