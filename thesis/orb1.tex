\chapter{Support for the weighted orbital integral for $S_3(F)$}
\label{ch:orbital1}

In this section we set up the framework of the weighted orbital integral
based on the definitions in the previous section.
This involves rewriting the integral as an infinite discrete double sum
over two parameters $(n,m)$ that we will introduce later,
and determining the volume of the supports of the indicator function.

\section{Reparametrization in terms of valuations}
\subsection{Computation of value in indicator function}
We are integrating over $t_1 \in E$ and $t_2 \in E$.
Regarding $h' \in H'$ as an element of $\GL_3(E)$ as described before, we have
\[ h' = \begin{pmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{pmatrix}. \]
We therefore have
\[ \bar{h'}\inv = \begin{pmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{pmatrix}. \]
Hence
\begin{align*}
  \bar{h'} \inv \gamma h'
  &=
  \begin{pmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{pmatrix}
  \begin{pmatrix}
    a & 0 & 0 \\
    b & - \bar d & 1 \\
    c & 1 - d \bar d & d
  \end{pmatrix}
  \begin{pmatrix}
  t_1 & t_2 & 0  \\
  \bar t_2 & \bar t_1 & 0 \\
  0 & 0 & 1
  \end{pmatrix} \\
  &=
  \begin{pmatrix}
  \frac{t_1}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  \frac{-t_2}{t_1 \bar t_1 - t_2 \bar t_2} & \frac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} & 0 \\
  0 & 0 & 1 \end{pmatrix}
  \begin{pmatrix}
    at_1 & at_2 & 0 \\
    bt_1 - \bar d \bar t_2 & b t_2 - \bar d \bar t_1 & 1 \\
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{pmatrix}
  \\
  &=
  \begin{pmatrix}
    \dfrac{at_1^2 - bt_1 \bar t_2 + d \bar t_2^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{at_1t_2 - bt_2 \bar t_2 + \bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-\bar t_2}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    \dfrac{-at_1t_2+bt_1\bar t_1-\bar d \bar t_1 \bar t_2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{-at_2^2+b\bar t_1 t_2-d\bar t_1^2}{t_1 \bar t_1 - t_2 \bar t_2}
    & \dfrac{\bar t_1}{t_1 \bar t_1 - t_2 \bar t_2} \\[2ex]
    ct_1 + (1-d\bar d)\bar t_2 & ct_2 + (1-d \bar d) \bar t_1 & d
  \end{pmatrix}
\end{align*}
At this point, note that the entry $d$ appears by itself at the bottom-right.

Let us define
\[ t = t_2 \bar t_1 \inv \iff t_2 = t \bar t_1. \]
This lets us rewrite everything in terms of the ratio $t$ and $t_1 \in E$:
\[
  \bar{h'} \inv \gamma h'
  =
  \begin{pmatrix}
    \dfrac{t_1^2(a-b\bar t+\bar d \bar t^2)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \bar t_1(at-bt\bar t+\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{t_1 \cdot (-\bar t)}{t_1 \bar t_1 (1-t \bar t)} \\[2ex]
    \dfrac{t_1\bar t_1(-at+b-\bar d \bar t)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{\bar t_1^2(-at^2+bt-\bar d)}{t_1 \bar t_1(1-t \bar t)}
    & \dfrac{-\bar t_1}{t_1 \bar t_1(1-t \bar t)} \\[2ex]
    t_1(c + (1-d\bar d)\bar t) & \bar t_1(ct + (1-d \bar d)) & d
  \end{pmatrix}
\]
This new parametrization is better because $t_1$ only plays the role of
a scale factor on the outside, with ``interesting'' terms only involving $t$.
To make this further explicit, we write
\[ t_1 = \varpi^{-m} \epsilon \]
for $m \in \ZZ$ and $\epsilon \in \OO_E^\times$.
Then
\begin{align*}
  &\phantom=
  \begin{pmatrix} \bar\epsilon \\ & \epsilon \\ & & 1 \end{pmatrix}
  \bar{h'} \inv \gamma h'
  \begin{pmatrix} \epsilon\inv \\ & \bar\epsilon\inv \\ & & 1 \end{pmatrix} \\
  &=
  \begin{pmatrix}
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
  & \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
  & \dfrac{-\varpi^m \bar t}{1-t \bar t} \\[2ex]
  \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
  & \dfrac{-at^2+bt-\bar d}{1-t \bar t}
  & \dfrac{-\varpi^m}{1-t \bar t} \\[2ex]
  \dfrac{c + (1-d\bar d)\bar t}{\varpi^m} & \dfrac{ct + (1-d \bar d)}{\varpi^m} & d
  \end{pmatrix}.
\end{align*}
For brevity, we will let $\Gamma(\gamma, t, m)$ denote the right-hand matrix.
The conjugation by
$\left( \begin{smallmatrix} \epsilon\inv \\ & \bar\epsilon\inv \\ & & 1 \end{smallmatrix} \right)$
has no effect on any of the $K'_{S, \le r}$, so that we can simply use
\[ \mathbf{1}_{K'_{S, \le r}}(\bar{h'}\inv \gamma h') = \mathbf{1}_{K'_{S, \le r}}(\Gamma(\gamma, t, m)) \]
in the work that follows.
For brevity, we abbreviate
\[ \mathbf{1}_{\le r}(\gamma, t, m) \coloneqq \mathbf{1}_{K'_{S, \le r}}(\Gamma(\gamma, t, m)). \]

\subsection{Reparametrizing the integral in terms of $t$ and $m$}
From now on, following \cite[\S4]{ref:AFL} we always fix the notation
\begin{align*}
  m &= m(t_1) \coloneqq -v(t_1) \\
  n &= n(t) \coloneqq v(1-t\bar t).
\end{align*}
(At the risk of stating the obvious, this $n$ is not the same $n$ in $\GL_n$, etc.)
We need to rewrite the integral, phrased originally via $\odif{h'}$,
in terms of the parameters $t$ (hence $n$), $m$, and $\gamma$.
We start by observing that
\[ \det h' = t_1 \bar t_1 - t_2 \bar t_2 = t_1 \bar t_1 (1 - t\bar t) \]
which means that
\[ v(\det h') = -2m + n \]
ergo
\begin{align*}
\left\lvert \det h' \right\rvert_F &= q^{-v(\det h')} = q^{2m-n} \\
\eta(h') &= (-1)^{v(\det h')} = (-1)^n.
\end{align*}
Meanwhile, from $t_2 = t \bar t_1$ we derive
\[ \odif t_2 = \left\lvert t_1 \right\rvert_E \odif t = q^{2m} \odif t. \]

Bringing this all into the weighted orbital integral gives
\begin{align*}
  \Orb(\gamma, \mathbf{1}_{K'_{S, \le r}} s)
  &= \kappa \int_{t, t_1 \in E} \mathbf{1}_{\le r}(\gamma, t, m)
  (-1)^n \left( q^{2m-n} \right)^{s-2} \odif t_1 \cdot (q^{2m} \odif t) \\
  &= \kappa \int_{t, t_1 \in E} \mathbf{1}_{\le r}(\gamma, t, m)
  (-1)^n q^{s(2m-n)} \cdot q^{2n-2m} \odif t \odif t_1.
\end{align*}

\section{Description of the support of $\mathbf{1}_{\le r}$ when $n \le 0$}
\begin{proposition}
  Whenever $n = 0$ (this requires $v(t) \geq 0$),
  \[
    \mathbf{1}_{\le r}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  We have to consider the nine entries of $\Gamma(\gamma, t, m)$ in tandem.

  The upper $2 \times 2$ matrix is always in $\omega^{-r}\OO_E$,
  because $v(t) \geq 0$, $v(d) \geq -r$, $v(b) \geq -r$, and $v(a) = 0$ suffices.

  In the right column, since $v(t) \geq 0$ and $n = 0$, the condition is simply $m \ge -r$.

  In the bottom row, we need
  \begin{align*}
    v\left( c+(1-d\bar d) \bar t \right)-m &\geq -r, \\
    v\left( ct +(1-d\bar d) \right)-m &\geq -r.
  \end{align*}
  If $v(t) > 0$ this is equivalent to $m-r \leq \delta$.
  In the case where $v(t) = 0$ we instead use the observation that
  \begin{equation}
    \left[ c + (1-d \bar d) \bar t \right]
    - \bar t \left[ ct + (1-d \bar d) \right] = (1-t\bar t) c
    \label{eq:ctrick}
  \end{equation}
  which forces at least one of $ct + (1-d \bar d)$ and $c + (1-d \bar d) \bar t$ to
  have valuation $\delta$. So the claim follows now.
\end{proof}

\begin{proposition}
  Suppose $n = -2k < 0$, equivalently, $v(t) = -k < 0$, for some $k$.
  \[
    \mathbf{1}_{\le r}(\gamma, t, m) =
    \begin{cases}
      1 & \text{if } -r \le m+k \le \delta+r \\
      0 & \text{otherwise.}
    \end{cases}
  \]
\end{proposition}
\begin{proof}
  The proof is similar to the previous claim, but simpler.

  Since $k > 0$, the fraction $\frac{t^2}{1-t \bar t}$ has positive valuation,
  so the upper $2 \times 2$ supmatrix of $\Gamma(\gamma, t, m)$ is always in $\varpi^{-r}\OO_E$.
  Turning to the right column, the condition reads exactly $m+k \geq -r$.
  Finally, in the bottom row, from $v(t) > 0$ and $v(c) = \delta$
  the condition is simply $-k+\delta-m \geq -r$.
\end{proof}

Note all the results in this section hold for any $b$ and $d$
with $v(b) \ge -r$ and $v(d) \ge -r$, i.e.~we do not yet need to consider cases
based on whether $b$ and $d$ are units or not.

\section{Description of the support of $\mathbf{1}_{\le r}$ when $n > 0$}
In this situation we evaluate over $n > 0$ only.
In this case $t$ is automatically a unit.

Consider the upper $2 \times 2$ supmatrix of $\Gamma(\gamma, t, m)$.
Using the identities
\begin{align*}
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    - \bar t \cdot \dfrac{at-bt\bar t+\bar d \bar t}{1-t \bar t}
    &= a-b\bar t \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{a-b\bar t+\bar d \bar t^2}{1-t \bar t}
    + \bar t \cdot \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    &= a \in \varpi^{-r} \OO_E \\[2ex]
  \dfrac{-at+b-\bar d \bar t}{1-t \bar t}
    - \bar t \cdot \dfrac{-at^2+bt-\bar d}{1-t \bar t}
    &= -a+b \in \varpi^{-r} \OO_E,
\end{align*}
it follows that as soon as one entry in the upper $2 \times 2$
supmatrix is in $\varpi^{-r} \OO_E$, then all four are.
Focusing on the fraction with numerator $-at^2+bt-\bar d$
we use the identity
\[ (2at-b)^2 - (b^2-4a\bar d) = -4a(-at^2+bt-\bar d) \]
to rewrite $v(-at^2+bt-\bar d) \geq n-r$ as
\[ v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r. \]
This takes care of all four of the entries in the upper $2 \times 2$ supmatrix.

Meanwhile, the requirements on the other entries amount to
\begin{align}
  m & \geq n - r \\
  v\left( c+(1-d \bar d) \bar t \right) &\geq m-r \label{eq:cddtop} \\
  v\left( ct+(1-d \bar d) \right) &\geq m-r \label{eq:cddbot} \\
  v(d) &\ge -r \label{eq:vd_ge_minus_r}.
\end{align}
According to the earlier identity \eqref{eq:ctrick}, if \eqref{eq:cddtop} is assumed true,
then \eqref{eq:cddbot} is equivalent to
\[ \delta + v(1-t \bar t) \ge m-r. \]
Meanwhile, since $v(c+(1-d \bar d) \bar t) = v(\bar c + (1-d \bar d)t)$,
\eqref{eq:cddtop} is itself equivalent to
\[ v(t+u) + \delta \geq m-r \]
by reading the definition of \eqref{eq:u}.

In summary:
\begin{proposition}
  Assume $t$ is such that $n = v(1-t \bar t) > 0$.
  Then $\mathbf{1}_{\le r}(\gamma, t, m) = 1$ if and only if $v(d) \ge -r$,
  \[ n - r \leq m \leq n + \delta + r \]
  and $t$ lies in the set specified by
  \begin{equation}
    \begin{aligned}
      v\left( (2at-b)^2 - (b^2-4a\bar d) \right) &\geq n-r \\
      v(t+u) &\ge m-\delta-r.
    \end{aligned}
    \label{eq:two_disks_S3}
  \end{equation}
\end{proposition}

\section{Rewriting the quadratic constraint on the valuation of $t$ in the $n > 0$ situation}
We now analyze the inequality
\begin{equation}
  v\left( (2at-b)^2 - (b^2-4a\bar d) \right) \geq n-r
  \label{eq:2atb_dos}
\end{equation}
and divide it into several (disjoint) possibilities.
Recalling that $\ell = b^2 - 4 a \bar d$, there are several possibilities:
\begin{itemize}
  \ii If $\ell \ge n-r$, then \eqref{eq:2atb_dos} is equivalent to
  \begin{equation}
    2v(2at-b) \ge n-r
    \iff v\left( t - \frac{b}{2a} \right) \ge \left\lceil \frac{n-r}{2} \right\rceil.
    \label{eq:t_disk_case_1_2}
  \end{equation}
  We will further subdivide this into two cases.
  \begin{itemize}
    \ii \textbf{Case 1} is the situation where $\left\lceil \frac{n-r}{2} \right\rceil \ge m - \delta - r$.
    \ii \textbf{Case 2} is the situation where $\left\lceil \frac{n-r}{2} \right\rceil < m - \delta - r$.
  \end{itemize}

  \ii If $\ell < n-r$, then \eqref{eq:2atb_dos} could only hold if $v(2at-b) = \frac{\ell}{2}$.
  Note that in particular, this requires $\ell$ to be even.

  If this happens, then as we saw in \Cref{prop:parameter_constraints}
  the quantity $b^2 - 4 a \bar d$ must be a square and we denote it $\tau^2$.
  Thus, \eqref{eq:2atb_dos} then reads
  \begin{equation}
    v(2at-b+\tau) + v(2at-b-\tau) \ge n-r.
    \label{eq:case_3_4_dos}
  \end{equation}
  Since we are assuming $n > \ell + r$,
  it must be the case that one of the two factors
  $v(2at-b\mp\tau)$ is equal to $v(\tau) = \ell / 2$ exactly,
  and the other is at least $n - r - \frac{\ell}{2} > \frac{\ell}{2}$.

  Hence, there is one situation where $v(2at-b+\tau) = \frac{\ell}{2}$ and
  \begin{equation}
    v\left( t - \frac{b+\tau}{2a} \right) = v(2at-b-\tau) \ge n - \frac{\ell}{2} - r
    \label{eq:t_disk_plus_case}
  \end{equation}
  Note that conversely \eqref{eq:t_disk_plus_case} implies \eqref{eq:case_3_4_dos}.
  We further subdivide this into two cases:
  \begin{itemize}
    \ii \textbf{Case 3\ts+} is the situation where $n - \frac{\ell}{2} - r > m - \delta - r$.
    \ii \textbf{Case 4\ts+} is the situation where $n - \frac{\ell}{2} - r \le m - \delta - r$.
  \end{itemize}
  Replacing $\tau$ with $-\tau$ above in \eqref{eq:t_disk_plus_case} yields
  the other situation where $v(2at-b-\tau) = \frac{\ell}{2}$ and
  \begin{equation}
    v\left( t - \frac{b-\tau}{2a} \right) = v(2at-b+\tau) \ge n - \frac{\ell}{2} - r
    \label{eq:t_disk_minus_case}
  \end{equation}
  which gives us two additional cases.
  We denote them \textbf{Case 3\ts-} and \textbf{Case 4\ts-}.
\end{itemize}

This gives us six cases, with each $t \in E$ satisfying at most one of them.
(If $\ell$ is odd, only \textbf{Case 1} and \textbf{Case 2} are used.)
In each case, for a given pair $(n,m)$ we are interested in the volume of $t$
such that two disk inequalities hold together with the assumption $n = v(1-t \bar t)$.

We rewrite these six cases in the format specified by \Cref{lem:quadruple_ineq},
noting that each possibility will actually split into two sub-cases
(although the lemma will only apply in the cases where the centers
$\xi_i$ are actually in $\OO_E^\times$;
this which will be true in the main case $v(b) = v(d) = 0$).
This gives \Cref{tab:orbital_cases}.

\begin{table}[h]
  \centering
  \begin{tabular}{ll cc}
    \toprule
    & Assume & $\xi_1$ and $\xi_2$ & $\rho_1$ and $\rho_2$ \\\midrule
    \textbf{1}
      & $n \le \ell+r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b}{2a} \\
        \xi_2 &= -u \\
        v(1-\xi_1 \bar{\xi_1}) &= v(4-b\bar{b}) \\
        v(\xi_1 - \xi_2) &= v(au - \bar d \bar u)
        \end{aligned}$
      & $\begin{aligned}
        &\phantom{\ge} \left\lceil \tfrac{n-r}{2} \right\rceil \\
        &\ge m-\delta-r
        \end{aligned}$
        \\\hline
    \textbf{2}
      & $n \le \ell+r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b}{2a} \\
        v(1-\xi_1 \bar{\xi_1}) &= \lambda \\
        v(\xi_1-\xi_2) &= v(au- \bar d \bar u)
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> m-\delta-r \\
        &> \left\lceil \tfrac{n-r}{2} \right\rceil
      \end{aligned}$ \\\hline
    \textbf{3\ts+}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b+\tau}{2a} \\
        \xi_2 &= -u \\
        v(1 - \xi_1 \bar{\xi_1}) &= v(1-\tfrac{\Norm(b+\tau)}{4}) \\
          &= \lambda + \delta - \ell \\
        v(\xi_1-\xi_2) &= v(au - \bar d \bar u + \tau) \\
          &= \lambda + v(d) - \tfrac{\ell}{2}
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> n-\frac{\ell}{2}-r \\
        &> m-\delta-r
      \end{aligned}$ \\\hline
    \textbf{3\ts-}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= \tfrac{b-\tau}{2a} \\
        \xi_2 &= -u \\
        v(1 - \xi_1 \bar{\xi_1}) &= v(1-\tfrac{\Norm(b-\tau)}{4}) \\
          &= \delta \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u-\tau) \\
          &= \tfrac{\ell}{2}
      \end{aligned}$
      & $\begin{aligned}
        &\phantom> n-\frac{\ell}{2}-r \\
        &> m-\delta-r
      \end{aligned}$ \\\hline
    \textbf{4\ts+}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b+\tau}{2a} \\
        v(1 - \xi_1 \bar{\xi_1}) &= \lambda \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u+\tau) \\
          &= \lambda + v(d) - \tfrac{\ell}{2}
        \end{aligned}$
      & $\begin{aligned}
        &\phantom\ge m-\delta-r \\
        &\ge n-\frac{\ell}{2}-r
        \end{aligned}$ \\\hline
    \textbf{4\ts-}
      & $n > \ell + r$
      & $\begin{aligned}
        \xi_1 &= -u \\
        \xi_2 &= \tfrac{b-\tau}{2a} \\
        v(1 - \xi_1 \bar{\xi_1}) &= \lambda \\
        v(\xi_1-\xi_2) &= v(au-\bar d \bar u-\tau) \\
          &= \tfrac{\ell}{2}
        \end{aligned}$
      & $\begin{aligned}
        &\phantom\ge m-\delta-r \\
        &\ge n-\frac{\ell}{2}-r
      \end{aligned}$ \\\bottomrule
  \end{tabular}

  \caption{The six cases for calculating the weighted orbital integral for $S_3(F)$,
    in the inhomogeneous group version of the AFL.}
  \label{tab:orbital_cases}
\end{table}

Note that in generating \Cref{tab:orbital_cases}, we did the calculations
\begin{align*}
  v\left( u + \frac{b}{2a} \right)
  &= v\left( \frac{au-\bar d \bar u}{2a} \right)
  = v(au - \bar d \bar u) \\
  v\left( u + \frac{b \pm \tau}{2} \right)
  &= v(au - \bar d \bar u \pm \tau).
\end{align*}
to populate the entries for $v(\xi_1 - \xi_2)$,
as well as the identity
\[ 1 - \frac{b \pm \tau}{2a} \cdot \frac{\bar b \pm \bar \tau}{2\bar a}
= \frac{4 - \Norm(b \pm \tau)}{4} \]
to calculate $v(1-\xi_1\bar{\xi_1})$ entries in the latter four cases.

\section{Case analysis}
Up until now the analysis has been valid for all five cases of
\Cref{prop:parameter_constraints}.
However, starting from now on we will have to be a little more careful
and think about which situation of \Cref{prop:parameter_constraints} we are in.

\subsection{Analysis of Case 1 and 2 assuming $n > 0$ and $v(b) = 0$}
We analyze Case 1 and 2 assuming $v(b) = 0$.

Considering $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
we compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}_{\le r}(\gamma,t,m) = 1$.

In addition to the constraint $n \le \ell + r$,
we see that the two cases have the following additional requirements:
\begin{description}
  \ii[Case 1] If $m < \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$ then we need
  \begin{align}
    v(4-b\bar b) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq1} \\
    v(au - \bar d \bar u) &\ge m - \delta - r \label{eq:odd_ineq2}.
  \end{align}

  \ii[Case 2] If $m \geq \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$ then we need
  \begin{align}
    \lambda = v(1-u \bar u) &\ge m-\delta-r \label{eq:odd_ineq3} \\
    v(au - \bar d \bar u) &\ge \left\lceil \frac{n-r}{2} \right\rceil \label{eq:odd_ineq4}.
  \end{align}
\end{description}

We will now show that some of these inequalities are redundant and can be ignored.
\begin{lemma}
  If $v(b) = 0$, then \eqref{eq:odd_ineq2} and \eqref{eq:odd_ineq4} are redundant
  i.e.\ they are automatically true for $0 < n \le \ell + r$.
\end{lemma}
\begin{proof}
  This is immediate from \Cref{lem:au_minus_du}.
\end{proof}

\begin{lemma}
  If $v(b) = 0$, then \eqref{eq:odd_ineq1} is redundant.
\end{lemma}
\begin{proof}
  Regardless of whether $v(d) = 0$ or $v(d) > 0$, the equation
  \[ (4-b \bar b) = -4au(1-d\bar d) - \bar b(b^2-4a\bar d) \]
  always implies
  \begin{equation}
    v(4-b\bar b) \ge \min(\ell,\delta) \text{ with equality if } \ell \neq \delta
    \label{eq:bb_odd}
  \end{equation}
  sinec $-4au$ and $\bar b$ are units.
  Hence, a priori \eqref{eq:bb_odd} suggests that we have a condition
  $n \le r + 2 \delta$ in addition to $n \le r + \ell$.
  However, by \Cref{prop:parameter_constraints}, we always have $\ell \le 2 \delta$,
  and consequently \eqref{eq:odd_ineq1} is redundant as well.
\end{proof}

Putting all of this together, we find that the valid pairs $(n,m)$ come in two cases.

\begin{description}
\item[Double sum for Case 1]
We sum over $(m,n)$ such that
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    n-r &\leq m \leq \left\lceil \frac{n-r}{2} \right\rceil+\delta+r - 1
  \end{aligned}
  \label{eq:odd_range1}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\begin{equation}
  \begin{cases}
    q^{-n - \left\lceil \frac{n-r}{2} \right\rceil} \left( 1 - q\inv \right)
      & \text{if $n > r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $n \leq r$}.
  \end{cases}
  \label{eq:case_1_vol_contrib}
\end{equation}

\item[Double sum for Case 2]
We sum over $(m,n)$ such that
\begin{equation}
  \begin{aligned}
    1 &\leq n \leq \ell + r, \\
    \max\left(n-r, \left\lceil \frac{n-r}{2} \right\rceil+\delta+r \right)
    &\leq m \leq \min(n,\lambda)+\delta+r
  \end{aligned}
  \label{eq:odd_range2}
\end{equation}
where each $(m,n)$ gives a volume contribution of
\begin{equation}
  \begin{cases}
    q^{-n - (m-\delta-r)} \left( 1 - q\inv \right)
      & \text{if $m > \delta + r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $m \le \delta + r$}.
  \end{cases}
  \label{eq:case_2_vol_contrib}
\end{equation}
Notice that $m \leq \delta + r$ could only occur when $n \leq r$.
\end{description}

\subsection{Analysis of merged Case 1 and 2 assuming $n > 0$ and $v(b) > 0$}
If $v(b) > 0$ instead, so that $\ell = 0$ but still $\delta \ge 0$.
Then \eqref{eq:t_disk_case_1_2} becomes independent of the unit $t$ because we must have
\[ v\left( t - \frac{b}{2a} \right) = 0. \]
Consequently, in this situation, it is not necessary to distinguish between Cases 1 and 2.
Instead, \eqref{eq:two_disks_S3} merely requires that
\begin{align*}
  0 &\ge n - r \\
  v(t+u) &\ge m - \delta - r
\end{align*}
In this situation, by \Cref{lem:volume},
we get a nonzero contribution in the merged case if and only if
\begin{equation}
  \begin{aligned}
    1 &\le n \le r \\
    n-r &\le m \le n + \delta + r \\
    \lambda &\ge m - \delta - r.
  \end{aligned}
  \label{eq:vb_pos_range}
\end{equation}
In that case the volume contribution is given by the same expression as \eqref{eq:case_2_vol_contrib}.

To avoid having to consider the situation $v(b) > 0$ separately,
we make the following observation:
\begin{lemma}
  Consider the two (disjoint) ranges \eqref{eq:odd_range1} and \eqref{eq:odd_range2}
  in the special case $\ell = 0$.
  These two ranges collectively cover exactly the same elements $(m,n)$
  as \eqref{eq:vb_pos_range}.
  Moreover, the volume contribution \eqref{eq:case_1_vol_contrib}
  equals that of \eqref{eq:case_2_vol_contrib} for pairs $(m,n)$ in \eqref{eq:odd_range1}.
  \label{prop:folding_cases_1_2}
\end{lemma}
\begin{proof}
  If we combine \eqref{eq:odd_range1} and \eqref{eq:odd_range2}, they say that
  \begin{align*}
    1 &\le n \le \ell + r = r \\
    n-r &\le m \le \min(n,\lambda) + \delta + r = \min(n, \lambda) + r
  \end{align*}
  which matches \eqref{eq:vb_pos_range} exactly.
  So it remains to verify that the volume contributions match.

  Now suppose that $m < \left\lceil \frac{n-r}{2} \right\rceil + \delta + r$.
  Since $n \le r$, it follows that $m \le \delta + r$.
  So on the one hand we have the $n \le r$ case in \eqref{eq:case_1_vol_contrib}
  and on the other hand we have the $m \le \delta + r$ case in \eqref{eq:case_2_vol_contrib},
  which both equal $q^{-n}(1-q^{-2})$.
  Hence the proof is complete.
\end{proof}
Because of this proposition then we can fold the $v(b) > 0$
result into the case $v(b) = 0$ too in future calculations.
In other words the double sums in Case 1 and 2 mentioned in the previous subsection
will work verbatim even in the $v(b) > 0$ situation, which is convenient.

\begin{remark}
  Note that in the original paper \cite{ref:AFL} only $r = 0$ is considered
  and in this case all three ranges \eqref{eq:odd_range1}, \eqref{eq:odd_range2}
  and \eqref{eq:vb_pos_range} are empty.
  Therefore the corresponding step in the calculation of \cite{ref:AFL}
  is much simpler, consisting only of the one-line observation that
  Case 1 and Case 2 cannot occur at all if $r = 0$.
  In contrast once $r > 0$ then the ranges are not necessarily empty
  and therefore one needs to ensure that the terms arising actually match.
\end{remark}

\subsection{Analysis of Case 3\ts+, 3\ts-, 4\ts+, 4\ts- assuming $n > 0$ and $v(b) \ge 0$ and $v(d) \ge 0$}
Suppose $\ell \geq 0$ is even.
As before we consider $n > 0$ and $n-r \le m \le n+\delta+r$ as fixed,
and seek to compute the volume of the set of $t$
for which $n = v(1-t\bar t)$ and $\mathbf{1}_{\le r}(\gamma,t,m) = 0$.

\begin{description}
\ii[Double sum for Case 3\ts+]
Suppose $n > \ell + r$,
$m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b+\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda + \delta - \ell = v(4-\Norm(b+\tau)) &\geq n - \frac{\ell}{2} - r \\
  \lambda + v(d) - \frac{\ell}{2} = v(au-\bar d \bar u + \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \max(1, \ell+r+1) &\leq n \leq -\frac{\ell}{2} + \delta + \lambda + r, \\
  n-r &\leq m \leq \min\left( n+\delta+r, n - \frac{\ell}{2}+\delta - 1,
    \lambda + v(d) -\frac{\ell}{2}+\delta+r \right)
\end{align*}
which from $\ell, \delta, r \ge 0$ can be simplified to just
\begin{align*}
  \ell+r+1 &\leq n \leq  -\frac{\ell}{2} + \delta + \lambda + r, \\
  n-r &\leq m \leq \min(n-1, \lambda + v(d) + r) - \frac{\ell}{2} + \delta
\end{align*}
Moreover, in any situation where $v(d) > 0$, we have $\ell = \delta = 0$,
and hence $n-1 < \lambda + r < \lambda + v(d) + r$ is obvious.
Thus we may drop the $v(d)$ term from the inequality and obtain
\begin{equation}
  \begin{aligned}
    \ell+r+1 &\leq n \leq \lambda - \frac{\ell}{2} + \delta + r, \\
    n-r &\leq m \leq \min(n-1, \lambda + r) - \frac{\ell}{2} + \delta
  \end{aligned}
  \label{eq:even_case3_plus}
\end{equation}
Each $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \frac{\ell}{2} - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 3\ts-]
Suppose $n > \ell + r$,
$m < n - \frac{\ell}{2} + \delta$, and we choose $\frac{b-\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \delta = v(4-\Norm(b-\tau)) &\geq n - \frac{\ell}{2} - r \\
  \frac{\ell}{2} = v(au-\bar d \bar u - \tau) & \geq m - \delta - r.
\end{align*}
Compiling all seven constraints gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \ell + r + 1 &\leq n \leq \frac{\ell}{2}+\delta+r, \\
  n-r &\leq m \leq \min\left( n - \frac{\ell}{2}+\delta - 1,
    \frac{\ell}{2} + \delta + r, n + \delta + r \right)
\end{align*}
This simplifies to
\begin{equation}
  \begin{aligned}
    \ell+r+1 &\leq n \leq \frac{\ell}{2}+\delta+r, \\
    n-r &\leq m \leq \frac{\ell}{2} + \delta + r.
  \end{aligned}
  \label{eq:even_case3_minus}
\end{equation}
As in the previous case, $(m,n)$ gives a volume contribution of
\[ q^{-n - (n - \frac{\ell}{2} - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 4\ts+]
Suppose $n > \ell + r$,
$m \ge n - \frac{\ell}{2} + \delta$
(which implies $m \ge n-r$ since $r \ge 0$ and $0 \le \ell \le 2 \delta$),
and we choose $\frac{b+\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \lambda + v(d) - \frac{\ell}{2} = v(au-\bar d \bar u + \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
Rearranging gives that the valid pairs $(m,n)$ are those for which
\begin{align*}
  \ell + r + 1 &\leq n \leq \lambda + v(d) + r \\
  n - \frac{\ell}{2} + \delta &\leq m \leq \min(n, \lambda) + \delta + r.
\end{align*}
However, in any situation where $v(d) > 0$ and hence $\ell = \delta = 0$,
the inequality on $m$ already implies that $n \le \lambda + r$.
Hence we may drop the $v(d)$ term to get instead the inequalities
\begin{equation}
  \begin{aligned}
    \ell + r + 1 &\leq n \leq \lambda + r \\
    n - \frac{\ell}{2} + \delta &\leq m \leq \min(n, \lambda) + \delta + r.
  \end{aligned}
  \label{eq:even_case4_plus}
\end{equation}
Here, each $(m,n)$ gives a volume contribution of
\[ q^{-n - (m - \delta - r)} \left( 1 - q\inv \right). \]

\ii[Double sum for Case 4\ts-]
Suppose $n > \ell + r$,
$m \ge n - \frac{\ell}{2} + \delta$, and we choose $\frac{b-\tau}{2a}$.
Then \Cref{lem:quadruple_ineq} gives a nonzero contribution if and only if
\begin{align*}
  \lambda &\geq m - \delta - r \\
  \frac{\ell}{2} = v(au-\bar d \bar u - \tau) & \geq n - \frac{\ell}{2} - r.
\end{align*}
The latter inequality contradicts the assumption that $n > \ell + r$,
so in fact this case can never occur.
\end{description}

\section{Case analysis when $v(b) = v(d) < 0$}
We need to handle now the situation where $v(b) = v(d) < 0$.
In that case we have $\ell = \delta = 2v(d) < 0$.

For \textbf{Case 3\ts+}, \textbf{Case 3\ts-}, \textbf{Case 4\ts+}, \textbf{Case 4\ts-},
we still agree to fix the choice of square root $\tau$ such that
\eqref{eq:tau_choice} holds.
(Note that in the right-hand side of the first inequality,
we still have $\lambda + v(d) - \half \ell = \lambda > 0$.)

\subsection{Analysis of merged Case 1 and 2 assuming $v(b) = v(d) < 0$}
In the situation where $\ell \ge n - r$,
then for any unit $t$ we have $v(t-\frac{b}{2a}) = v(b) = -|v(d)| < 0$,
so \eqref{eq:t_disk_case_1_2} becomes simply
\[ v(b) \ge \left\lceil \frac{n-r}{2} \right\rceil \iff n \le r + 2 v(b) = r + \ell. \]
Thus, the only constraint on the unit $t$ is that
\[ v(t + u) \ge m - \delta - r. \]
So, by applying \Cref{lem:volume}, we find that the nonzero contributions occur exactly when
\begin{equation}
  \begin{aligned}
    1 &\le n \le -2|v(d)| + r \\
    n-r &\le m \le n - 2|v(d)| + r \\
    \lambda &\ge m + 2|v(d)| - r
  \end{aligned}
  \label{eq:ell_neg_12_range}
\end{equation}
with the same volume contribution given by \eqref{eq:case_2_vol_contrib}, that is.
\begin{equation}
  \begin{cases}
    q^{-n - (m+2|v(d)|-r)} \left( 1 - q\inv \right)
      & \text{if $m > -2|v(d)| + r$} \\
    q^{-n} \left( 1 - q^{-2} \right)
      & \text{if $m \le -2|v(d)| + r$}.
  \end{cases}
  \label{eq:ell_neg_12_vol}
\end{equation}

So an analysis almost identical to the one in \Cref{prop:folding_cases_1_2} applies here
to show that \eqref{eq:odd_range1} and \eqref{eq:odd_range2}
match the above range, with the same volume contributions.
This means that the same expression can be used for the case $v(b) = v(d) < 0$ as well.

\subsection{Analysis of Case 3\ts+ and Case 4\ts+ assuming $v(b) = v(d) < 0$}
Now suppose $n > \ell + r$ and $v(b) = v(d) < 0$.
In this situation, we have $\frac{b+\tau}{2a}$ is a unit, and
\[ \lambda =v\left( 1 - u \bar u \right) =  v\left( 1 - \frac{\Norm(b+\tau)}{4} \right). \]
Hence when we apply \Cref{lem:quadruple_ineq} we see that we are simply requiring that
\[ \lambda \ge \max\left( n - \frac{\ell}{2} - r, m - \delta - r \right) \]
with \textbf{Case 3\ts+} corresponding to
$n - \frac{\ell}{2} - r > m - \delta - r$
and \textbf{Case 4\ts+} corresponding to
$n - \frac{\ell}{2} - r \ge m - \delta - r$;
we do not separate these.
As before we immediately replace $\ell = \delta = -2|v(d)|$ above.

Consequently, we will need to sum over the range
\begin{equation}
  \begin{aligned}
    \max(1, -2|v(d)| + r + 1) &\leq n \leq \lambda - |v(d)| + r \\
    n - r &\leq m \leq \min(n, \lambda) - 2|v(d)| + r.
  \end{aligned}
  \label{eq:ell_neg_34_range}
\end{equation}
The volume contribution is now given by
\begin{equation}
  \begin{cases}
    q^{-n - \max(n+|v(d)|-r, m+2|v(d)|-r)} (1 - q\inv) &\text{if } \max(n+|v(d)|-r, m+2|v(d)|-r) > 0 \\
    q^{-n} (1 - q^{-2}) &\text{if } \max(n+|v(d)|-r, m+2|v(d)|-r) \le 0.
  \end{cases}
  \label{eq:ell_neg_34_vol}
\end{equation}
since $\max(n+|v(d)|-r, m+2|v(d)|-r)$ could actually be non-positive,
in contrast to the earlier cases.

\subsection{Analysis of Case 3\ts- and Case 4\ts+ assuming $v(b) = v(d) < 0$}
Again suppose $n > \ell + r$ and $v(b) = v(d) < 0$.
In this case, \eqref{eq:t_disk_minus_case} becomes simply
\[ \frac{\ell}{2} = v\left( t - \frac{b-\tau}{2a} \right) \ge n - \frac{\ell}{2} - r \]
which implies $n \le \ell + r$.
So actually neither \textbf{Case 3\ts-} nor \textbf{Case 4\ts-} could happen.
